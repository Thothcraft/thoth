{% extends "base.html" %}

{% block title %}WiFi Setup - {{ super() }}{% endblock %}

{% block content %}
<div class="max-w-md mx-auto">
    <div class="card">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Welcome to Thoth Device</h2>
            <p class="mt-2 text-gray-600">Please connect to a WiFi network to get started</p>
        </div>
        
        <form id="wifiForm" class="space-y-4">
            <div>
                <label for="ssid" class="block text-sm font-medium text-gray-700 mb-1">WiFi Network</label>
                <select id="ssid" name="ssid" class="form-input" required>
                    <option value="" disabled selected>Select a network...</option>
                    {% for network in available_networks %}
                    <option value="{{ network.ssid }}" data-secure="{{ network.secure }}">
                        {{ network.ssid }}{% if network.secure %} (Secured){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div id="passwordField" class="hidden">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" id="password" name="password" class="form-input" autocomplete="off">
            </div>
            
            <div id="loginFields" class="hidden space-y-4 pt-4 border-t border-gray-200 mt-6">
                <h3 class="text-lg font-medium text-gray-900">Sign In</h3>
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username or Email</label>
                    <input type="text" id="username" name="username" class="form-input" required>
                </div>
                <div>
                    <label for="user_password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="user_password" name="user_password" class="form-input" required>
                </div>
            </div>
            
            <div class="pt-4 flex justify-end space-x-3">
                <button type="button" id="scanButton" class="btn btn-secondary">
                    <i class="fas fa-sync-alt mr-2"></i>Scan
                </button>
                <button type="submit" id="connectButton" class="btn btn-primary">
                    <i class="fas fa-wifi mr-2"></i>Connect
                </button>
            </div>
        </form>
    </div>
    
    <div class="mt-6 text-center text-sm text-gray-500">
        <p>Need help? Contact support@thoth.device</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ssidSelect = document.getElementById('ssid');
    const passwordField = document.getElementById('passwordField');
    const passwordInput = document.getElementById('password');
    const loginFields = document.getElementById('loginFields');
    const wifiForm = document.getElementById('wifiForm');
    const scanButton = document.getElementById('scanButton');
    
    // Show/hide password field based on network security
    ssidSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const isSecure = selectedOption.dataset.secure === 'true';
        
        passwordField.classList.toggle('hidden', !isSecure);
        if (isSecure) {
            passwordInput.required = true;
            loginFields.classList.remove('hidden');
        } else {
            passwordInput.required = false;
            loginFields.classList.add('hidden');
        }
    });
    
    // Handle form submission
    wifiForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(wifiForm);
        const data = {
            ssid: formData.get('ssid'),
            password: formData.get('password'),
            username: formData.get('username'),
            login: formData.get('username') ? true : undefined,
            user_password: formData.get('user_password')
        };
        
        try {
            const response = await axios.post('/wifi/config', data);
            showAlert('WiFi configured successfully!', 'success');
            
            if (response.data.redirect) {
                setTimeout(() => {
                    window.location.href = response.data.redirect;
                }, 2000);
            }
        } catch (error) {
            handleError(error);
        }
    });
    
    // Handle scan button click
    scanButton.addEventListener('click', async function() {
        try {
            const response = await axios.get('/api/wifi/scan');
            const networks = response.data.networks || [];
            
            // Clear existing options except the first one
            while (ssidSelect.options.length > 1) {
                ssidSelect.remove(1);
            }
            
            // Add scanned networks
            networks.forEach(network => {
                const option = new Option(
                    `${network.ssid}${network.secure ? ' (Secured)' : ''}`,
                    network.ssid
                );
                option.dataset.secure = network.secure;
                ssidSelect.add(option);
            });
            
            showAlert('Network scan completed', 'success');
        } catch (error) {
            handleError(error);
        }
    });
    
    // Initial scan
    scanButton.click();
});
</script>
{% endblock %}
